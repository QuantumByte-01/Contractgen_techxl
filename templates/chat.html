{% extends "base.html" %}
{% block title %}Iterative Contract Chat{% endblock %}
{% block content %}
<div class="card p-4">
  <h2>Iterative Contract Modification</h2>
  <p>Below is the latest contract. Enter your request below to update it.</p>

  <div class="border p-3 mb-3 bg-white" id="chatContractBox">
    {{ contract|safe }}
  </div>

  <form id="chatForm" method="POST" action="{{ url_for('chat') }}">
    <input type="hidden" name="contract_html" id="chat_contract_html">
    <div class="mb-3">
      <label class="form-label">Your Message or Requested Changes:</label>
      <textarea class="form-control" name="user_message" rows="3"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Send to Model</button>
    <a href="{{ url_for('index') }}" class="btn btn-link">Back to Home</a>
  </form>
</div>

{% block scripts %}
<script>
  // If there's a 'contract' from the server, store it in localStorage
  let updatedFromServer = `{{ contract|tojson|safe }}`;
  if (updatedFromServer.trim() !== "") {
    localStorage.setItem("contract_html", updatedFromServer);
  }

  // On form submit, pass the localStorage contract to the server
  document.getElementById("chatForm").addEventListener("submit", function(){
    let stored = localStorage.getItem("contract_html") || "No contract generated.";
    document.getElementById("chat_contract_html").value = stored;
  });
</script>
{% endblock %}
{% endblock %}
